<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <title>新开出货单</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <script type="text/javascript">
        jQuery = require('jquery')
        $ = jQuery;
        console.log(jQuery.fn.jquery)
    </script>
    <script src="scripts/pgquery.js"></script>


    <script src="scripts/jquery-ui/jquery-ui.js"></script>
    <script src="scripts/select2.full.min.js"></script>
    <script type="text/javascript" src="scripts/accounting.min.js"></script>

    <!--<script src="jq.js"></script>-->
    <!--<script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>-->


    <!-- Le styles -->
    <!-- Bootstrap -->
    <link href="scripts/jquery-ui/jquery-ui.css" rel="stylesheet">
    <link href="styles/select2.min.css" rel="stylesheet">
    <link href="scripts/bootstrap/css/bootstrap.css" rel="stylesheet">
    <!--<link href="scripts/bootstrap/css/doc.min.css" rel="stylesheet">-->
    <style>
        body {
            padding-top: 60px;
            /* 60px to make the container go all the way to the bottom of the topbar */
        }
    </style>
    <link href="data:text/css;charset=utf-8," data-href="scripts/bootstrap/css/bootstrap-theme.css" rel="stylesheet"
          id="bs-theme-stylesheet">
    <!--<link href="../assets/css/bootstrap-responsive.css" rel="stylesheet">-->

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
    <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="../assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="../assets/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="../assets/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="../assets/ico/apple-touch-icon-57-precomposed.png">
    <link rel="shortcut icon" href="../assets/ico/favicon.png">

    <script>
        var ipc = require('ipc');
      //  var ipc2 = require('ipc')
        var user = ipc.sendSync('session', {opt: 'get', key: 'user'});
        console.log('Login user: ' + user.name); // prints "pong"

        ipc.on("hide_overlay", function(event, arg) {
            $("#__m").modal('hide');
        });

        var hide_overlay = function() {
            $("#__m").modal("hide")
        }

        var logout = function () {
            // if (window.confirm("确定退出？")) {
            // doLogout()
            var ret = ipc.sendSync('session', {opt: 'clear', key: ''});
            if (ret == 'true') {
                console.log("Clear session!")
                user = ipc.sendSync('session', {opt: 'get', key: 'user'});
                console.log('User -> ' + user); // prints "pong"
            }
            document.location.href = "login.html"
            // }
        }
    </script>


</head>

<body>


<nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1"
                    aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" style="color:black; font-size:18px;" href="#">苏州元斌塑胶科技有限公司KIS</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li class="active"><a href="#">新开出库单 <span class="sr-only">(current)</span></a></li>
                <li><a href="sale-order-list.html">出货单列表</a></li>  <!--javascript:findByOrderNumber(100052)-->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true"
                       aria-expanded="false">系统管理<span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#">用户设置</a></li>
                        <li><a href="#">修改密码</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a href="#">One more separated link</a></li>
                    </ul>
                </li>
            </ul>
            <!--<form class="navbar-form navbar-left" role="search">
            <div class="form-group">
              <input type="text" class="form-control" placeholder="Search">
            </div>
            <button type="submit" class="btn btn-default">Submit</button>
          </form>-->
            <ul class="nav navbar-nav navbar-right">

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" id="kis-u" data-toggle="dropdown" role="button"
                       aria-haspopup="true" aria-expanded="false">
                        <script>
                            document.write(user.name)
                        </script>
                        <span class="caret"></span></a>
                    <ul class="dropdown-menu">
                        <li><a href="#">用户设置</a></li>
                        <li role="separator" class="divider"></li>
                        <li><a data-toggle="modal" data-target="#myModal" href="javascript:void(0);">退出账户</a></li>
                    </ul>
                </li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container-fluid -->
</nav>


<style type="text/css">
    .container {
        width: 100%;
    }

    .ui-autocomplete {
        max-height: 350px;
        /*高度值*/
        overflow-y: auto;
        /*超过高度出现滚动条*/
        /*width:300px;*/
        overflow-x: hidden;
    }

    .ui-autocomplete-category {
        font-weight: bold;
        padding: .2em .4em;
        margin: .8em 0 .2em;
        line-height: 1.5;
    }

    .bill_table td {
        padding: 10px 0px;
        vertical-align: middle;
    }

    .bill_product_table {
        border-collapse: collapse;
        border: 1px solid #aaa;
    }

    .bill_product_table th {
        text-align: center;
        border: 1px solid #aaa;
        padding: 20px auto;
        height: 40px;
    }

    .bill_product_table td {
        text-align: left;
        padding: 4px 0.5% 4px 0.5%;
        height: 32px;
        vertical-align: middle;
        border: 1px solid #aaa;
        /*background-color:#eee;*/
    }

    /*.odd {
      background-color: #eee
    }*/

    input {
        border: 1px solid steelblue;
        height: 30px;
        line-height: 30px;
        padding-left: 8px;

    }

    .bill_product_table input {
        width: 100%;
        background-color: #fafafa;
        height: 30px;
        line-height: 30px;
        border: 1px solid steelblue;
    }

    /*
         .product_modal select>option {
            display:block;
           font-size: 14px;
           padding-top: 6px;
           padding-bottom:6px;
        }*/

    .select2-container--default .select2-selection--single {
        background-color: #fff;
        border: 1px solid steelblue;
        border-radius: 0px;
        height: 30px;

    }
</style>


<div class="container">
    <div style="text-algin:center;">
        <table class="bill_table" style="width:100%; margin:20px auto 0px; text-algin:left;">
            <tr>
                <td colspan="3" style="padding-right:70px;">
                    <label for="customer_name">客户名称：</label>
                    <select id="customer_name" style="width:280px; ">
                        <option></option>
                    </select>
                </td>
                <td colspan="2">
                    <!--<label for="customer_principal">联系人：</label>
                    <input id="customer_principal" style="" />-->
                    &nbsp;
                </td>

                <td id="sale_date_div" colspan="2" style="float:right;">
                    <label for="sale_date">送货日期：</label>
                    <input id="sale_date" type="text"/>
                </td>
            </tr>
            <tr>
                <td colspan="3">
                    <label for="customer_address">送货地址：</label>
                    <input style="width:350px;" id="customer_address"/>
                </td>
                <td colspan="2">
                    <label for="customer_principal">联系人：</label>
                    <input id="customer_principal"/>
                </td>
                <td colspan="2" style="float:right">
                    <label for="customer_phone">客户电话：</label>
                    <input id="customer_phone"/>
                </td>
            </tr>
        </table>
    </div>
    <!--<tr>
        <td colspan="7" style="border:1px solid black;">-->
    <table class="bill_product_table" style="width:100%;">
        <tr>
            <th width="20%">规格型号</th>
            <th width="18%">货物名称</th>
            <th width="10%">单位</th>
            <th width="10%">数量</th>
            <th width="9%">价格</th>
            <th width="13%">金额</th>
            <th width="20%">备注</th>
        </tr>


        <tr idx="1">
            <td>
                <select class="product_modal"></select>
            </td>
            <td>
                <input type="text" class="product_category"/>
            </td>
            <td>
                <input type="text" class="product_units"/>
            </td>
            <td>
                <input type="text" class="product_num"/>
            </td>
            <td>
                <input type="text" class="product_unit_price"/>
            </td>
            <td>
                <input type="text" class="product_sum"/>
            </td>
            <td>
                <input type="text" class="product_memo"/>
            </td>
        </tr>


        <tr id="total_sum_tr">
            <td colspan="7" style="text-align: right;font-weight: bold;">
                合计金额：<span id="product_total_sum" style="margin-right: 20%;"></span>
            </td>
        </tr>
    </table>
    <!--<table class="print_sign_table" style="width:100%;margin:20px 0 10px;">
            <tr>
                <td style="width:33.3%; text-align: center;">财务：</td>
                <td style="width:33.3%; text-align: center;">制单：<input type="text" id="zd" />
              </script>
                </td>
                <td style="width:33.3%; text-align: center;">客户签收：</td>
            </tr>
        </table>-->
    <!--<div style="text-align:center; wdith:100%; margin-top:40px; border:1px dashed #aaa;"><span>----白联:留存</span><span style="margin-left:30px;">----红联:客户</span><span style="margin-left:30px;">----黄联:结算</span></div>-->
</div>
<!-- /container -->

<div style="text-align:center; margin-top:40px;">
    <button class="btn btn-default btn-primary" type="submit" onclick="document.location.reload()"> 重 填</button>
    <button class="btn btn-default btn-primary" style="margin-left:150px;" onclick="print_order()"> 打 印</button>
</div>

<!-- Button trigger modal -->
<!--<button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
  Launch demo modal
</button>-->

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                        aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">登出</h4>
            </div>
            <div class="modal-body">

                <br>
                <br>
                确定要登出？
                <br>
                <br>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" onclick="logout();">确定</button>
            </div>
        </div>
    </div>
</div>


<div id="dialog" style="display:none;">
    <label for="city">城市</label>
    <select name="city" id="city">
    </select>

    <label for="color">筛选</label>
    <input name="color" id="color"/>
</div>
<!-- Le javascript
  ================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<!--<script src="../assets/js/jquery.js"></script>-->
<script src="scripts/bootstrap/js/bootstrap.js"></script>
<script>

    function findByOrderNumber(order_number) {
        pgquery({
            sql: findSaleOrder, params: [order_number], doResult: function (result) {
                var json_data = result.rows[0].data;
                console.log(json_data)
                var r = ipc.sendSync('session', {opt: 'put', key: 'order', value: {order_info: json_data, type:"select"}});
                $('#__m').modal('show')
                //var r = ipc.sendSync('hide_main_window', {});
                p_win = window.open('sale-order-preview.html', '打印', "width=800,height=600,alwaysOnTop=true");
                window.onfocus = function () {
                    if (!p_win.closed) {
                        p_win.focus();
                    }
                }
            }});
    }



    var customerData = new Array();
    var customerInfo = new Array();
    var modals = new Array();
    accounting.settings = {
        currency: {
            symbol: "¥",   // default currency symbol is '$'
            format: "%s%v", // controls output: %s = symbol, %v = value/number (can be object: see below)
            decimal: ".",  // decimal point separator
            thousand: ",",  // thousands separator
            precision: 2   // decimal places
        },
        number: {
            precision: 0,  // default precision on numbers is 0
            thousand: ",",
            decimal: "."
        }
    }
    var p_win = null;

    var c_customer_id = null;
    var c_customer_name = null;
    var c_customer_address = null;
    var c_customer_phone = null;
    var c_customer_principal = null;
    var c_sale_date = null;
    var c_product_modals = null;
    var c_product_total_sum = null;

    function print_order() {
        //window.print();
        c_customer_id = $('#customer_name').val()
        for (var i = 0; i < customerData.length; i++) {
            var _children = customerData[i].children;
            for (var j = 0; j < _children.length; j++) {
                if (_children[j].id == c_customer_id) {
                    c_customer_name = _children[j].text;
                    break;
                }
            }
        }
        c_customer_address = $('#customer_address').val();
        c_customer_principal = $('#customer_principal').val();
        c_customer_phone = $('#customer_phone').val();
        c_sale_date = $('#sale_date').val();
        c_product_total_sum = $('#product_total_sum').html();
        if (c_product_total_sum != '') {
            c_product_total_sum = accounting.unformat(c_product_total_sum)
        }

        c_product_modals = new Array();
        var _modals = $('.product_modal');
        for (var i = 0; i < _modals.length; i++) {
            var modal_id = $(_modals[i]).val();
            if (modal_id <= 0) {
                continue;
            }

            var modal_name = getProductModalNameById(modal_id);
            var idx = $(_modals[i]).parent().parent().attr("idx");
            var product_category = $('tr[idx="' + idx + '"] .product_category').val();
            var product_category_id = $('tr[idx="' + idx + '"] .product_category').attr("category_id");
            var product_num = $('tr[idx="' + idx + '"] .product_num').val();
            var product_units = $('tr[idx="' + idx + '"] .product_units').val();
            var product_unit_price = $('tr[idx="' + idx + '"] .product_unit_price').val();
            var product_sum = $('tr[idx="' + idx + '"] .product_sum').val();
            var product_memo = $('tr[idx="' + idx + '"] .product_memo').val();


            c_product_modals.push({
                product_modal_id: modal_id,
                product_modal_name: modal_name,
                product_category_id: product_category_id,
                product_category_name: product_category,
                product_units: product_units,
                product_num: product_num,
                product_unit_price: product_unit_price,
                product_sum: product_sum,
                product_memo: product_memo
            })

        }


        function getProductModalNameById(id) {
            for (var j = 0; j < modals.length; j++) {
                var options = modals[j].options;
                for (var k = 0; k < options.length; k++) {
                    if (options[k].modal_id == id) {
                        return options[k].modal_name;
                    }
                }
            }
            return null;
        }


        var order_info = {
            customer_id: c_customer_id,
            customer_name: c_customer_name,
            customer_address: c_customer_address,
            customer_principal: c_customer_principal,
            customer_phone: c_customer_phone,
            sale_date: c_sale_date,
            modals: c_product_modals,
            create_user: user.name,
            create_user_id: user.id,
            product_total_sum: c_product_total_sum
        };

        var order = {order_info: order_info, type:"create"}

        pgquery({
            sql: getCurrentOrderNumber, params: [], doResult: function (result) {
                order.order_info.order_number = result.rows[0].order_number;
                order.order_number = order.order_info.order_number;
                console.log(JSON.stringify(order_info))
                var r = ipc.sendSync('session', {opt: 'put', key: 'order', value: order});

                // way1
               // r = ipc.sendSync('show_print_win', {url:'sale-order-preview.html'});


                $('#__m').modal('show')
                //var r = ipc.sendSync('hide_main_window', {});
                p_win = window.open('sale-order-preview.html', '打印', "width=900,height=600,alwaysOnTop=true");
                window.onfocus = function () {
                    if (!p_win.closed) {
                        p_win.focus();
                    }
                }
            }
        });
    }


    function initSaleDate() {
        $("#sale_date").datepicker({
            changeMonth: true,
            changeYear: true,
            dateFormat: 'yy-mm-dd',//日期格式
            clearText: "清除",//清除日期的按钮名称
            closeText: "关闭",//关闭选择框的按钮名称
            prevText: '<上月',
            nextText: '下月>',
            currentText: '今天',
            yearSuffix: '年', //年的后缀
            showMonthAfterYear: true,//是否把月放在年的后面
            monthNames: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
            monthNamesShort: ['一月', '二月', '三月', '四月', '五月', '六月', '七月', '八月', '九月', '十月', '十一月', '十二月'],
            dayNames: ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'],
            dayNamesShort: ['周日', '周一', '周二', '周三', '周四', '周五', '周六'],
            dayNamesMin: ['日', '一', '二', '三', '四', '五', '六'],
            showButtonPanel: true,
            gotoCurrent: true
        });
        $("#sale_date").datepicker("setDate", new Date());
    }

    function clear_modal_items() {
        $('.product_category').val('');
        $('.product_units').val('');
        $('.product_unit_price').val('');
        $('.product_num').val('');
        $('.product_sum').val('');
        $('.product_memo').val('');
    }

    function change_modal(src) {
        var _modal_id = $(src).val();
        var _idx = $(src).parent().parent().attr('idx');  // tr attr 'idx'
        if (_modal_id == 0 || _modal_id == '') {
            // 选择空项目

            $('tr[idx="' + _idx + '"] .product_category').val('');
            $('tr[idx="' + _idx + '"] .product_category').attr("category_id", '');

            $('tr[idx="' + _idx + '"] .product_units').val('');
            $('tr[idx="' + _idx + '"] .product_units').attr("units_id", '');
            $('tr[idx="' + _idx + '"] .product_unit_price').val('');

            $('tr[idx="' + _idx + '"] .product_num').val('');
            $('tr[idx="' + _idx + '"] .product_sum').val('');
            $('tr[idx="' + _idx + '"] .product_memo').val('');
            // 重新计算金额
            changeNumOrUnitPrice(src);
            return;

            //  $('.product_category[idx="'+_idx+'"]').val('');
            //  $('.product_category[idx="'+_idx+'"]').attr("category_id", '');

            //  $('.product_units[idx="'+_idx+'"]').val('');
            //  $('.product_units[idx="'+_idx+'"]').attr("units_id", '');
            //  $('.product_unit_price[idx="'+_idx+'"]').val('');

            //  $('.product_num[idx="'+_idx+'"]').val('');
            //  $('.product_sum[idx="'+_idx+'"]').val('');
            //  $('.product_memo[idx="'+_idx+'"]').val('');
        }

        var found = false;
        for (var i = 0; i < modals.length; i++) {
            var modalOptions = modals[i].options;
            for (var j = 0; j < modalOptions.length; j++) {
                if (modalOptions[j].modal_id == _modal_id) {
                    $('tr[idx="' + _idx + '"] .product_category').val(modalOptions[j].category_name);
                    $('tr[idx="' + _idx + '"] .product_category').attr("category_id", modalOptions[j].category_id);

                    $('tr[idx="' + _idx + '"] .product_units').val(modalOptions[j].units_name);
                    $('tr[idx="' + _idx + '"] .product_units').attr("units_id", modalOptions[j].units_id);
                    $('tr[idx="' + _idx + '"] .product_unit_price').val(modalOptions[j].suggest_unit_price);

                    found = true;
                    break;
                }
            }

            if (found)
                break;
        }
        // 重新计算金额
        changeNumOrUnitPrice(src);
    }

    function changeNumOrUnitPrice(src) {
        var idx = $(src).parent().parent().attr('idx')
        var j_product_num = $('tr[idx="' + idx + '"] .product_num');
        var j_product_unit_price = $('tr[idx="' + idx + '"] .product_unit_price');
        var j_product_sum = $('tr[idx="' + idx + '"] .product_sum');

        var v_product_num = j_product_num.val();
        var v_product_unit_price = j_product_unit_price.val();
        var v_product_sum;

        if ($.trim(v_product_num) == '') {
            if ($.trim(v_product_unit_price) == '') {
                j_product_unit_price.val('');
            } else {
                j_product_unit_price.val(accounting.formatNumber(v_product_unit_price, 2));
            }

            j_product_num.val('');
            j_product_sum.val('');

        } else {
            j_product_num.val(accounting.formatNumber(j_product_num.val()))
            if ($.trim(v_product_unit_price) == '') {
                j_product_unit_price.val('');
                j_product_sum.val('');
            } else {
                j_product_unit_price.val(accounting.formatNumber(v_product_unit_price, 2));
                //alert(accounting.unformat(j_product_unit_price.val()))
                var sum = accounting.unformat(j_product_num.val()) * accounting.unformat(j_product_unit_price.val()) * 100 / 100
                j_product_sum.val(accounting.formatNumber(sum, 2))
            }
        }

        $('#product_total_sum').html(getTotalSum());
    }

    function getTotalSum() {
        var arr_modals = $('.product_modal');
        var arr_sum = $('.product_sum');
        var show_total_sum = true;
        var total_sum = 0;
        for (var i = 0; i < arr_modals.length; i++) {

            if ($(arr_modals[i]).val() > 0) {
                // 没选
                var _sum_val = $(arr_sum[i]).val();
                if (_sum_val == '') {
                    return '';
                } else {
                    total_sum += accounting.unformat(_sum_val);
                }
            }
        }

        return accounting.formatMoney(total_sum);
    }

    $(function () {
        //$('#customer_name').html();
        $('#customer_name').select2();

        for (var i = 2; i <= 5; i++) {
            var tr = $('tr[idx="1"]').clone();
            $(tr).attr("idx", i);
            $(tr).insertBefore($('#total_sum_tr'));

        }

        $('.product_modal').html('<option class="opt" value="0">&nbsp;</option>');
        $('.product_modal').select2({width: '100%'});
        initSaleDate();
        $('.product_num').on('change', function () {
            changeNumOrUnitPrice(this);
        })
        $('.product_unit_price').on('change', function () {
            changeNumOrUnitPrice(this);
        })

        pgquery({
            sql: getCustomers, params: [], doResult: function (result) {
                var rows = result.rows;
                if (rows.length > 0) {
                    for (var i = 0; i < rows.length; i++) {
                        var found = false;
                        var _customer_option = {id: rows[i].customer_id, text: rows[i].customer_name};
                        var _customer_info = {
                            address: rows[i].address,
                            phone: rows[i].mobile_number,
                            principal: rows[i].principal
                        };
                        for (var j = 0; j < customerData.length; j++) {
                            if (rows[i].city_name == customerData[j].text) {
                                customerData[j].children.push(_customer_option)
                                customerInfo['"' + rows[i].customer_id + '"'] = _customer_info;
                                found = true;
                                break;
                            }
                        }
                        if (!found) {
                            customerData.push({text: rows[i].city_name, children: [_customer_option]});
                            customerInfo['"' + rows[i].customer_id + '"'] = _customer_info;
                        }
                    }
                }

                $('#customer_name').select2('destroy');
                $('#customer_name').select2({
                    data: customerData,
                    //allowClear: true,
                    placeholder: "请选择公司"
                })

                $('#customer_name').on('change',
                        function () {
                            var _id = $('#customer_name').val();
                            $('#customer_address').val(customerInfo['"' + _id + '"'].address);
                            $('#customer_phone').val(customerInfo['"' + _id + '"'].phone);
                            $('#customer_principal').val(customerInfo['"' + _id + '"'].principal);

                            // get product_modals
                            var ccid = $('#customer_name').val()
                            modals = new Array();
                            pgquery({
                                sql: getProductModals, params: [ccid], doResult: function (res) {

                                    if (res.rows.length > 0) {
                                        // alert(result.rows.length)
                                        for (var i = 0; i < res.rows.length; i++) {
                                            var category_id = res.rows[i].category_id;
                                            var category_name = res.rows[i].category_name;
                                            var modal_name = res.rows[i].modal_name;
                                            var modal_id = res.rows[i].modal_id;
                                            var units_id = res.rows[i].units_id;
                                            var units_name = res.rows[i].units_name;
                                            var suggest_unit_price = res.rows[i].suggest_unit_price;
                                            var found = false;

                                            var _option_modal = {
                                                modal_name: modal_name,
                                                modal_id: modal_id,
                                                category_id: category_id,
                                                category_name: category_name,
                                                units_id: units_id,
                                                units_name: units_name,
                                                suggest_unit_price: suggest_unit_price
                                            };

                                            for (var j = 0; j < modals.length; j++) {
                                                if (modals[j].category_id == category_id) {
                                                    modals[j].options.push(_option_modal)
                                                    found = true;
                                                    break;
                                                }
                                            }

                                            if (!found)
                                                modals.push({
                                                    category_id: category_id,
                                                    category_name: category_name,
                                                    options: [_option_modal]
                                                })
                                        }
                                    }

                                    var s = '<option class="opt" value="0">&nbsp;</option>';
                                    for (var k = 0; k < modals.length; k++) {
                                        s += '<optgroup label="' + modals[k].category_name + '">';
                                        var options = modals[k].options;
                                        for (var x = 0; x < options.length; x++) {
                                            s += '<option class="opt" units="' + options[x].units + '" value="' + options[x].modal_id + '">' + options[x].modal_name + '</option>'
                                        }
                                        s += '</optgroup>';
                                    }

                                    $('.product_modal').select2('destroy');
                                    $('.product_modal').html(s);
                                    clear_modal_items();
                                    $('.product_modal').select2({width: '100%'});
                                    $('.product_modal').on('change', function () {
                                        change_modal(this);
                                    });
                                }
                            });
                        });
            }
        });


    });
</script>
<div id="__m"></div>
</body>
</html>